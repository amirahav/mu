---
appname: myvpc
<%
$azs = listAZs
%>
vpcs:
- name: vpc
  route-tables:
  - name: internet
    routes:
    - destination_network: 0.0.0.0/0
      gateway: "#INTERNET"
  - name: private
    routes:
    - destination_network: 0.0.0.0/0
      nat_host_name: bastion
  dependencies:
  - type: server
    name: bastion
  subnets:
<%
counter=0
(1..$azs.size).each do |i|
%>
  - name: Subnet<%= counter %>Public
    ip_block: 10.0.<%= counter %>.0/24
    availability-zone: "<%= $azs[i-1] %>"
    route-table: internet
<%
  counter = counter + 1
end
num_used = counter
(1..$azs.size).each do |i|
%>
  - name: Subnet<%= counter-num_used %>Private
    ip_block: 10.0.<%= counter %>.0/24
    availability-zone: "<%= $azs[i-1] %>"
    route-table: private
<%
  counter = counter + 1
end %>
servers:
  - name: bastion
    ssh_user: root
    size: t2.micro
    src-dst-check: false
    static_ip:
      assign_ip: true
    vpc:
      vpc_name: vpc
      subnet_name: Subnet<%= Random.rand($azs.size-1).floor %>Public
    ingress_rules:
    - proto: icmp
      hosts:
      - 10.0.0.0/8
    - proto: tcp
      port-range: 0-65535
      hosts:
      - 10.0.0.0/8
    - proto: udp
      port-range: 0-65535
      hosts:
      - 10.0.0.0/8
    run_list:
    - recipe[mu-tools::apply_security]
    - recipe[mu-tools::split_var_partitions]
    - recipe[mu-utility::nat]
