---
appname: wordpress-demo
<%
$azs = listAZs
%>
vpcs:
- name: wordpress-demo-vpc
  route-tables:
  - name: internet
    routes:
    - destination_network: 0.0.0.0/0
      gateway: #INTERNET
  - name: private
    routes:
    - destination_network: 0.0.0.0/0
      nat_host_name: bastion
  dependencies:
  - type: server
    name: bastion
  subnets:
<%
$azs.each.with_index { |az, i|
%>
  - name: Public<%= i %>
    ip_block: 10.0.<%= i %>.0/24
    availability-zone: <%= az %>
    route-table: internet
<%
}
offset = $azs.size
$azs.each.with_index { |az, i|
%>
  - name: Private<%= i %>
    ip_block: 10.0.<%= i + offset %>.0/24
    availability-zone: <%= az %>
    route-table: private
<%
}
%>
loadbalancers:
- name: wordpress-demo-lb
  vpc:
    vpc_name: wordpress-demo-vpc
    subnet_pref: all_public
    subnets: 
    - subnet_name: Public3
  ingress_rules:
  - port: 80
    hosts:
    - 0.0.0.0/0
  healthcheck:
   target: HTTP:80/heartbeat.php
   timeout: 5
   interval: 30
   unhealthy-threshold: 2
   healthy-threshold: 2
  listeners:
  - lb-port: 80
    lb-protocol: HTTP
    instance-port: 80
    instance-protocol: HTTP
  dependencies:
  - type: vpc
    name: wordpress-demo-vpc
databases:
- name: wordpress-demo-db
    creation_style: new
    db_family: mysql5.6
    engine: mysql
    port: 3306
    publicly_accessible: true
    size: db.t2.micro
    storage: 5
    engine_version: 5.6.23
    vpc: 
      vpc_name: wordpress-demo-vpc
servers:
- name: bastion
  ssh_user: root
  size: t2.small
  src-dst-check: false
  static_ip: 
    assign_ip: true
  vpc: 
    vpc_name: wordpress-demo-vpc
    subnet_name: Public3
  application_attributes: 
    nat: 
      private_net: 10.1.0.0/16
  ingress_rules:
  - proto: icmp
    hosts:
    - 10.0.0.0/16
  - proto: tcp
    port-range: 0-65535
    hosts:
    - 10.0.0.0/16
  - proto: udp
    port-range: 0-65535
    hosts:
    - 10.0.0.0/16
- name: wordpress-demo-app
  loadbalancers:
  - concurrent-load-balancer: wordpress-demo-lb
  size: t2.medium
  static_ip:
   assign_ip: true
  storage:
  - device: /dev/sda1
    size: 70
  vpc: 
   vpc_name: wordpress-demo-vpc
   subnet_name: Public3
  dependencies:
  - type: loadbalancer
    name: wordpress-demo-lb
  - type: database
    name: wordpress-demo-db
  ingress_rules:
  - port: 80
    hosts:
    - 0.0.0.0/0
  - port: 443
    hosts:
    - 0.0.0.0/0  
  run_list:
  - recipe[demo::wordpress]
