---
appname: wordpress-demo
<%
$azs = listAZs
%>
vpcs:
- name: wordpress-demo-vpc
  route-tables:
  - name: internet
    routes:
    - destination_network: 0.0.0.0/0
      gateway: "#INTERNET"
  - name: private
    routes:
    - destination_network: 0.0.0.0/0
      nat_host_name: bastion
  dependencies:
  - type: server
    name: bastion
  subnets:
<%
counter=0
(1..$azs.size).each do |i|
%>
  - name: Public<%= counter %>
    ip_block: 10.0.<%= counter %>.0/24
    availability-zone: "<%= $azs[i-1] %>"
    route-table: internet
<%
  counter = counter + 1
end
num_used = counter
(1..$azs.size).each do |i|
%>
  - name: Private<%= counter-num_used %>
    ip_block: 10.0.<%= counter %>.0/24
    availability-zone: "<%= $azs[i-1] %>"
    route-table: private
<%
  counter = counter + 1
end %>
loadbalancers:
- name: wordpress-demo-lb
  vpc:
    vpc_name: wordpress-demo-vpc
    subnet_pref: all_public
    subnets: 
    - subnet_name: Public3
  ingress_rules:
  - port: 80
    hosts:
    - 0.0.0.0/0
  healthcheck:
   target: HTTP:80/heartbeat.php
   timeout: 5
   interval: 30
   unhealthy-threshold: 2
   healthy-threshold: 2
  listeners:
  - lb-port: 80
    lb-protocol: HTTP
    instance-port: 80
    instance-protocol: HTTP
  dependencies:
  - type: vpc
    name: wordpress-demo-vpc
databases:
- name: wordpress-demo-db
    engine: mysql
    creation_style: new
    db_family: mysql5.6
    vpc:
      vpc_name: wordpress-demo-vpc
    size: db.t2.micro
    version: 5.6.13
    storage: 5
    port: 3306
    publicly_accessible: true
servers:
- name: bastion
  ami-id: ami-bc8131d4
  ssh_user: root
  size: m3.medium
  src-dst-check: false
  static_ip: 
    assign_ip: true
  vpc: 
    vpc_name: wordpress-demo-vpc
    subnet_name: Public3
  application_attributes: 
    nat: 
      private_net: 10.1.0.0/16
  ingress_rules: 
    - 
      proto: icmp
      hosts: 
        - 10.0.0.0/16
    - 
      proto: tcp
      port-range: 1-65535
      hosts: 
        - 10.0.0.0/16
    - 
      proto: udp
      port-range: 1-65535
      hosts: 
        - 10.0.0.0/16
- name: wordpress-demo-app
  ami_id: ami-bc8131d4
  ssh_user: root
  loadbalancers:
  - concurrent-load-balancer: wordpress-demo-lb
  size: m3.medium
  static_ip:
   assign_ip: true
  storage:
  - size: 70
  vpc: 
   vpc_name: wordpress-demo-vpc
   subnet_name: Public3
  dependencies:
  - type: loadbalancer
    name: wordpress-demo-lb
  - type: database
    name: wordpress-demo-db
  ingress_rules:
  - port: 80
    hosts:
    - 0.0.0.0/0
  - port: 443
    hosts:
    - 0.0.0.0/0  
  run_list:
  - recipe[demo::wordpress]
admins:
- name: Admin
  email: admin@example.com
