<%
    # set up defaults
    $appname="wordpress-demo" if !$appname
    $nat_ssh_user="root" if !$nat_ssh_user
    $region = "us-east-1" if !$region
    $azs = listAZs

%>

---
appname: "<%=$appname %>"
region: "<%= $region %>"

vpcs:
- name: "vpc"
  route-tables:
  - name: internet
    routes:
    - destination_network: 0.0.0.0/0
      gateway: #INTERNET
  - name: private
    routes:
    - destination_network: 0.0.0.0/0
      nat_host_name: "bastion"
  dependencies:
  - type: server
    name: "bastion"
  subnets:
<%
$azs.each.with_index { |az, i|
%>
  - name: Public<%= i %>
    ip_block: 10.0.<%= i %>.0/24
    availability-zone: <%= az %>
    route-table: internet
<%
}
offset = $azs.size
$azs.each.with_index { |az, i|
%>
  - name: Private<%= i %>
    ip_block: 10.0.<%= i + offset %>.0/24
    availability-zone: <%= az %>
    route-table: private
<%
}
%>
loadbalancers:
- name: "lb"
  vpc:
    vpc_name: "vpc"
    subnet_pref: all_public
  ingress_rules:
  - port: 80
    hosts:
    - 0.0.0.0/0
  healthcheck:
   target: HTTP:80/heartbeat.php
   timeout: 5
   interval: 30
   unhealthy-threshold: 2
   healthy-threshold: 2
  listeners:
  - lb-port: 80
    lb-protocol: HTTP
    instance-port: 80
    instance-protocol: HTTP
  dependencies:
  - type: vpc
    name: "vpc"
databases:
- name: "db"
  creation_style: new
  db_family: mysql5.6
  engine: mysql
  port: 3306
  size: db.t2.micro
  storage: 5
  engine_version: 5.6.23
  vpc: 
    vpc_name: "vpc"
servers:
- name: "bastion"
  ssh_user: root
  size: t2.small
  src-dst-check: false
  static_ip: 
    assign_ip: true
  vpc: 
    vpc_name: "vpc"
    subnet_name: Public3
  application_attributes: 
    nat: 
      private_net: 10.0.0.0/16
  ingress_rules:
  - proto: icmp
    hosts:
    - 10.0.0.0/16
  - proto: tcp
    port-range: 0-65535
    hosts:
    - 10.0.0.0/16
  - proto: udp
    port-range: 0-65535
    hosts:
    - 10.0.0.0/16
  run_list: 
  - "recipe[mu-utility::nat]"
- name: "wpress"
  loadbalancers:
  - concurrent-load-balancer: "lb"
  size: t2.medium
  storage:
  - device: /dev/sda1
    size: 70
  vpc: 
   vpc_name: "vpc"
   subnet_name: Public3
  dependencies:
  - type: loadbalancer
    name: "lb"
  - type: database
    name: "db"
  image_then_destroy: true
  add_firewall_rules: 
    - rule_name: "wpress_secgroup"
  run_list:
  - recipe[demo::wordpress]
server_pools:
  - name: "wpress"
    min-size: 1
    max-size: 1
    ssh_user: "root"
    skipinitialupdates: true
    loadbalancers: 
    - concurrent-load-balancer: "lb"
    add_firewall_rules: 
      - rule_name: "wpress_secgroup"
    vpc:
      vpc_name: "vpc"
      subnet_pref: all_private
      nat_host_name: "bastion"
      nat_ssh_user: "root"
    run_list: 
    - "role[egt-jira]"
    dependencies: 
    - name: "lb"
      type: "loadbalancer"
    - name: "db"
      type: "database"    
    basis: 
      launch-config: 
        name: "wpress-launch"
        size: "t2.medium"
        server: "wpress"
firewall_rules:
  - name: "database_secgroup"
    vpc:
      vpc_name: "vpc"
    rules: 
    - port: 3306
      sgs: 
      - "wpress_secgroup"
  - name: "wpress_secgroup"
    vpc:
      vpc_name: "vpc"
    rules: 
    - port: 80
      lbs: 
      - "lb"
    dependencies: 
    - type: "loadbalancer"
      name: "lb"