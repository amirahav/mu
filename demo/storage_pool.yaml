<%
  $region = MU.curRegion unless $region
  subnets = MU.mySubnets
  subnets.uniq! { |subnet| subnet.availability_zone }
  subnet_ids = []
  subnets.map { |subnet| subnet_ids << subnet.subnet_id}
%>

parameters:
- name: instance_type
  default: t2.small
- name: vpc
  cloudtype: AWS::EC2::VPC::Id
  default: <%= MU.myVPC %>

appname: efs
region: <%= $region %>
storage_pools:
- name: demo
  mount_points:
  <% subnet_ids.each.with_index { |subnet, i| %>
  - name: mountpoint<%= i %>
    directory: /efs/demo
    vpc:
      vpc_id: <%= vpc %>
      subnet_id: <%= subnet %>
    ingress_rules:
    - port: 2049
      hosts:
      - 0.0.0.0/0
<% } %>

servers:
- name: demo
  dns_sync_wait: false
  skipinitialupdates: true
  platform: centos7
  size: <%= instance_type %>
  run_list:
  - recipe[mu-tools::efs]
  vpc:
    vpc_id: <%= vpc %>
    subnet_pref: private
  dependencies:
  - type: storage_pool
    name: demo
