#!/bin/sh
# Copyright:: Copyright (c) 2014 eGlobalTech, Inc., all rights reserved
#
# Licensed under the BSD-3 license (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License in the root of the project or at
#
#     http://egt-labs.com/mu/LICENSE.html
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

set -e

if [ -f /etc/debian_version ];then
	apt-get update -y
	if [ ! -f /usr/bin/pip ] ;then /usr/bin/apt-get --fix-missing -y install python-pip;fi
	if [ ! -f /usr/bin/curl ] ;then /usr/bin/apt-get --fix-missing -y install curl;fi
	AWSCLI=/usr/local/bin/aws
elif [ -x /usr/bin/yum ];then
	# Ugh, rando EPEL mirror
	if [ ! -f /etc/yum.repos.d/epel.repo ];then
		/bin/rpm -ivh http://mirror.metrocast.net/fedora/epel/6/i386/epel-release-6-8.noarch.rpm
	fi
	if [ ! -f /usr/bin/pip ] ;then /usr/bin/yum -y install python-pip;fi
	if [ ! -f /usr/bin/curl ] ;then /usr/bin/yum -y install curl;fi
	AWSCLI=/usr/bin/aws
fi
if [ ! -f $AWSCLI ];then
	/usr/bin/pip install awscli
fi

umask 0077

# Install Chef now, because why not?
if [ ! -f /opt/chef/embedded/bin/ruby ];then
	curl https://www.opscode.com/chef/install.sh > chef-install.sh
	set +e
	# We may run afoul of a synchronous bootstrap process doing the same thing. So
	# wait until we've managed to run successfully.
	while ! sh chef-install.sh -v <%= MU.chefVersion %>;do
		sleep 10
	done
	set -e
fi

$AWSCLI s3 cp s3://<%= MU.adminBucketName %>/<%= $mu.muID %>-secret .

echo '
require "openssl"
require "base64"
key = OpenSSL::PKey::RSA.new(Base64.urlsafe_decode64("<%= $mu.deployKey %>"))
print Base64.urlsafe_encode64(key.public_encrypt(File.read("<%= $mu.muID %>-secret")))
' > encrypt_deploy_secret.rb

deploykey="<%= $mu.deployKey %>"
instance_id="`curl http://169.254.169.254/latest/meta-data/instance-id`"

/usr/bin/curl -k --data mu_id="<%= $mu.muID %>" --data mu_resource_name="<%= $mu.resourceName %>" --data mu_resource_type="<%= $mu.resourceType %>" --data mu_instance_id="$instance_id" --data mu_bootstrap="1" --data mu_user="<%= $mu.muUser %>" --data mu_deploy_secret="`/opt/chef/embedded/bin/ruby encrypt_deploy_secret.rb`" https://<%= $mu.publicIP %>:2260/
/bin/rm -f <%= $mu.muID %>-secret mu_deploy_key.pub chef-install.sh encrypt_deploy_secret.rb
